<!doctype html>
<html lang="ar" dir="rtl">
<head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>واجهة الطالب</title>
<style>body{font-family:tahoma;max-width:900px;margin:12px auto;padding:8px}</style>
</head>
<body>
<h3>طالب - حل الامتحان</h3>
<label>اسم الطالب <input id="student_name"></label>
<label>الصف <input id="class"></label>
<label>المادة <input id="subject"></label>
<label>الشهر <select id="month"><option>اول</option><option>ثاني</option><option>ثالث</option></select></label>
<button onclick="loadExams()">جلب الامتحانات</button>

<div id="exams"></div>
<div id="examArea"></div>

<script>
function loadExams(){
  const cls = document.getElementById('class').value;
  const subject = document.getElementById('subject').value;
  const month = document.getElementById('month').value;
  fetch(`/api/exams?class=${encodeURIComponent(cls)}&subject=${encodeURIComponent(subject)}&month=${encodeURIComponent(month)}`)
  .then(r=>r.json()).then(list=>{
    if(!list.length) { document.getElementById('exams').innerHTML='لا يوجد امتحانات'; return; }
    document.getElementById('exams').innerHTML = list.map(e=>`ID:${e.exam_id} <button onclick="openExam(${e.exam_id})">حل الامتحان</button>`).join('<br>');
  });
}

let currentExam = null;
function openExam(id){
  fetch('/api/exam/'+id).then(r=>r.json()).then(data=>{
    currentExam = data;
    let html = `<h4>المادة:${data.exam.subject} الصف:${data.exam.class}</h4>`;
    html += `<form id="answersForm">`;
    data.questions.forEach(q=>{
      html += `<div><b>${q.question_text} [${q.score}]</b><br>`;
      q.choices.forEach(c=>{
        html += `<label><input type="radio" name="q${q.question_id}" value="${c.choice_id}"> ${c.choice_text}</label><br>`;
      });
      html += `</div><hr>`;
    });
    html += `<button type="button" onclick="submitAnswers()">ارسال</button></form>`;
    document.getElementById('examArea').innerHTML = html;
  });
}

function submitAnswers(){
  const student_name = document.getElementById('student_name').value;
  const student_class = document.getElementById('class').value;
  if(!student_name){ alert('حط اسمك'); return; }
  const answers = [];
  currentExam.questions.forEach(q=>{
    const sel = document.querySelector(`input[name="q${q.question_id}"]:checked`);
    if(sel) answers.push({question_id: q.question_id, choice_id: parseInt(sel.value)});
  });
  fetch('/api/submit',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
    student_name, student_class, exam_id: currentExam.exam.exam_id, answers
  })}).then(r=>r.json()).then(j=>{
    if(j.error) alert(j.error); else alert('تم الارسال');
  });
}
</script>
</body>
</html>
